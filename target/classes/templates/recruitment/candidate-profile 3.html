<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<div layout:fragment="content">

    <style>
        .profile-header { background: linear-gradient(135deg, #4f46e5, #3b82f6); color: #fff; border-radius: 16px; padding: 28px; margin-bottom: 25px; box-shadow: 0 4px 18px rgba(0,0,0,0.2); }
        .section-card { background: var(--card-bg); border-radius: 14px; padding: 22px; margin-bottom: 22px; border: 1px solid var(--border); box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .recommend-box { padding: 14px; border-left: 4px solid #4f46e5; background: var(--bg); border-radius: 8px; margin-bottom: 18px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
    </style>

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show">
        <i data-feather="check-circle"></i> <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show">
        <i data-feather="alert-circle"></i> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="profile-header d-flex justify-content-between align-items-center">
        <div>
            <h2 th:text="${app.fullName}">Alex Carter</h2>
            <div class="mt-2">
                <span class="badge bg-warning text-dark" th:text="${job.title}">Robotics Engineer</span>
                <span class="badge bg-light text-dark" th:text="${app.status}">Applied</span>
            </div>
            <div class="mt-3 text-white-75">
                <i data-feather="mail"></i> <span th:text="${app.email}"></span>
            </div>
            <div class="mt-1 text-white-75">
                <i data-feather="phone"></i> <span th:text="${app.phone}"></span>
            </div>
        </div>

        <a th:href="@{|/web/recruitment/applications/${app.jobId}|}"
           th:if="${app.jobId != null}"
           class="btn btn-light">
            <i data-feather="arrow-left"></i> Back to Applications
        </a>
        <a th:href="@{/web/recruitment/jobs}" th:unless="${app.jobId != null}" class="btn btn-light">
            <i data-feather="arrow-left"></i> Back to Jobs
        </a>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="section-card">
                <h5><i data-feather="activity"></i> AI Scoring Breakdown</h5>

                <div th:if="${score}">
                    <h2 class="fw-bold text-primary" th:text="${score.finalScore} + '%'">68%</h2>
                    <p><strong>Skills:</strong> <span th:text="${score.skillsScore}"></span>/50</p>
                    <p><strong>Experience:</strong> <span th:text="${score.experienceScore}"></span>/30</p>
                    <p><strong>Resume:</strong> <span th:text="${score.resumeScore}"></span>/20</p>

                    <a th:href="@{|/web/recruitment/candidate/${app.id}/recalculate|}"
                       class="btn btn-outline-primary btn-sm mt-3"
                       th:onclick="|this.innerHTML='<i data-feather=\'loader\' class=\'spin\'></i> Recalculating...'; feather.replace();|">
                        <i data-feather="refresh-cw"></i> Recalculate Score
                    </a>
                </div>

                <div th:if="${score == null}">
                    <p class="text-muted">Not scored yet.</p>
                    <a th:href="@{|/web/recruitment/score/${app.id}/${app.jobId}|}"
                       th:if="${app.jobId != null}"
                       class="btn btn-primary btn-sm">
                        <i data-feather="zap"></i> Run Initial Scoring
                    </a>
                    <span th:unless="${app.jobId != null}" class="text-danger">Job link missing</span>
                </div>
            </div>

            <div class="section-card">
                <h5><i data-feather="file-text"></i> Offer Letter</h5>
                <div th:if="${offer}">
                    <p><strong>Position:</strong> <span th:text="${offer.position}"></span></p>
                    <p><strong>Salary:</strong> ₹<span th:text="${#numbers.formatDecimal(offer.salary, 0, 2, 'COMMA')}"></span></p>
                    <p><strong>Joining:</strong> <span th:text="${offer.joiningDate}"></span></p>
                    <a th:href="@{'/web/recruitment/offer/download/' + ${app.id}}" class="btn btn-success btn-sm">
                        <i data-feather="download"></i> Download
                    </a>
                </div>
                <div th:if="${offer == null}">
                    <p class="text-muted">No offer generated.</p>
                    <a th:href="@{'/web/recruitment/offer/' + ${app.id}}" class="btn btn-primary btn-sm">
                        <i data-feather="plus"></i> Generate Offer
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="section-card">
                <h5><i data-feather="navigation"></i> Next Recommended Step</h5>
                <div class="recommend-box">
                    <strong th:text="${nextStep}">Shortlist or Reject</strong>
                </div>
            </div>

            <div class="section-card">
                <h5><i data-feather="flag"></i> Update Status</h5>
                <form th:action="@{'/web/recruitment/applications/status/' + ${app.id}}" method="post">
                    <select name="status" class="form-select mb-3">
                        <option value="Applied" th:selected="${app.status == 'Applied'}">Applied</option>
                        <option value="Shortlisted" th:selected="${app.status == 'Shortlisted'}">Shortlisted</option>
                        <option value="Interview Scheduled" th:selected="${app.status == 'Interview Scheduled'}">Interview Scheduled</option>
                        <option value="Interviewing" th:selected="${app.status == 'Interviewing'}">Interviewing</option>
                        <option value="Hired" th:selected="${app.status == 'Hired'}">Hired</option>
                        <option value="Rejected" th:selected="${app.status == 'Rejected'}">Rejected</option>
                    </select>
                    <button class="btn btn-primary">Update</button>
                </form>
            </div>

            <div class="section-card">
                <h5><i data-feather="calendar"></i> Interviews</h5>
                <div th:if="${interviews.isEmpty()}">
                    <p class="text-muted">No interviews scheduled.</p>
                    <a th:href="@{'/web/recruitment/interview/schedule/' + ${app.id}}" class="btn btn-primary btn-sm">
                        Schedule Interview
                    </a>
                </div>
                <ul th:if="${!interviews.isEmpty()}" class="list-group">
                    <li th:each="i : ${interviews}" class="list-group-item">
                        <strong th:text="${i.type}"></strong> on <span th:text="${i.date}"></span> at <span th:text="${i.time}"></span>
                    </li>
                </ul>
            </div>

            <div class="section-card">
                <h5><i data-feather="message-circle"></i> HR Notes</h5>
                <form th:action="@{'/web/recruitment/candidate/' + ${app.id} + '/note'}" method="post">
                    <textarea name="note" class="form-control mb-2" rows="2" placeholder="Add note..." required></textarea>
                    <button class="btn btn-primary btn-sm">Add Note</button>
                </form>
                <div th:each="n : ${notes}" class="border-start border-primary ps-3 mt-3">
                    <p class="mb-1" th:text="${n.note}"></p>
                    <small class="text-muted">
                        by <span th:text="${n.createdBy}"></span> • <span th:text="${#temporals.format(n.createdAt, 'dd MMM yyyy')}"></span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<div layout:fragment="scripts">
    <script>feather.replace();</script>
</div>
</html>